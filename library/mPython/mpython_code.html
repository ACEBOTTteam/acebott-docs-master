<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mpython.py源码 &mdash; ACEBOTT 2.2.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
          </a>
              <div class="version">
                2.2.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting%20started/Arduino/index.html">Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting%20started/ESP32/index.html">ESP32/ESP8266</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting%20started/Microbit/index.html">Microbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting%20started/ACECode%28Blockly%20Programming%29/index.html">ACECode</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Starter Kit</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../kit/Explorer%20Series/index.html">Explorer Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kit/STEM%20Education%20Series/index.html">STEM Education Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kit/Inventor%20Series/index.html">Inventor Series</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Controller Board</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../board/ESP32/index.html">ESP32/ESP8266</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../board/Arduino/index.html">Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../board/Microbit/index.html">Microbit</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electronic Module</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/Sensor/index.html">Sensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/Module/index.html">Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ACEBOTT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">mpython.py源码</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="mpython-py">
<span id="mpython-code"></span><h1>mpython.py源码<a class="headerlink" href="#mpython-py" title="Permalink to this heading"></a></h1>
<p><a class="reference download internal" download="" href="../../_downloads/95a4c00e213401329dba46a3ff4a7c06/mpython.py"><code class="xref download docutils literal notranslate"><span class="pre">mpython.py源码下载</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="c1"># labplus mPython library</span>
<span class="linenos">   2</span><span class="c1"># MIT license; Copyright (c) 2018 labplus</span>
<span class="linenos">   3</span><span class="c1"># V1.0 Zhang KaiHua(apple_eat@126.com)</span>
<span class="linenos">   4</span>
<span class="linenos">   5</span><span class="c1"># mpython buildin periphers drivers</span>
<span class="linenos">   6</span>
<span class="linenos">   7</span><span class="c1"># history:</span>
<span class="linenos">   8</span><span class="c1"># V1.1 add oled draw function,add buzz.freq().  by tangliufeng</span>
<span class="linenos">   9</span><span class="c1"># V1.2 add servo/ui class,by tangliufeng</span>
<span class="linenos">  10</span>
<span class="linenos">  11</span><span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">I2C</span><span class="p">,</span> <span class="n">PWM</span><span class="p">,</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">ADC</span><span class="p">,</span> <span class="n">TouchPad</span>
<span class="linenos">  12</span><span class="kn">from</span> <span class="nn">ssd1106</span> <span class="kn">import</span> <span class="n">SSD1106_I2C</span>
<span class="linenos">  13</span><span class="kn">import</span> <span class="nn">esp</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">network</span>
<span class="linenos">  14</span><span class="kn">import</span> <span class="nn">ustruct</span><span class="o">,</span> <span class="nn">array</span>
<span class="linenos">  15</span><span class="kn">from</span> <span class="nn">neopixel</span> <span class="kn">import</span> <span class="n">NeoPixel</span>
<span class="linenos">  16</span><span class="c1"># from esp import dht_readinto</span>
<span class="linenos">  17</span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep_ms</span><span class="p">,</span> <span class="n">sleep_us</span><span class="p">,</span> <span class="n">sleep</span>
<span class="linenos">  18</span><span class="kn">import</span> <span class="nn">framebuf</span> 
<span class="linenos">  19</span><span class="kn">import</span> <span class="nn">calibrate_img</span>
<span class="linenos">  20</span><span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">schedule</span><span class="p">,</span><span class="n">const</span>
<span class="linenos">  21</span><span class="kn">import</span> <span class="nn">NVS</span>
<span class="linenos">  22</span>
<span class="linenos">  23</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">I2C</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scl</span><span class="o">=</span><span class="n">Pin</span><span class="p">(</span><span class="n">Pin</span><span class="o">.</span><span class="n">P19</span><span class="p">),</span> <span class="n">sda</span><span class="o">=</span><span class="n">Pin</span><span class="p">(</span><span class="n">Pin</span><span class="o">.</span><span class="n">P20</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="mi">400000</span><span class="p">)</span>
<span class="linenos">  24</span>
<span class="linenos">  25</span><span class="k">if</span> <span class="s1">&#39;_print&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">():</span> <span class="n">_print</span> <span class="o">=</span> <span class="nb">print</span>
<span class="linenos">  26</span>
<span class="linenos">  27</span><span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<span class="linenos">  28</span>    <span class="n">_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_t</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">  29</span>    <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u4e00</span><span class="s1">&#39;</span> <span class="o">&lt;=</span> <span class="n">_s</span> <span class="o">&lt;=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u9fff</span><span class="s1">&#39;</span><span class="p">:</span>
<span class="linenos">  30</span>        <span class="n">_print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_t</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="linenos">  31</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">  32</span>        <span class="n">_print</span><span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
<span class="linenos">  33</span>
<span class="linenos">  34</span><span class="c1"># my_wifi = wifi()</span>
<span class="linenos">  35</span><span class="c1">#多次尝试连接wifi</span>
<span class="linenos">  36</span><span class="k">def</span> <span class="nf">try_connect_wifi</span><span class="p">(</span><span class="n">_wifi</span><span class="p">,</span> <span class="n">_ssid</span><span class="p">,</span> <span class="n">_pass</span><span class="p">,</span> <span class="n">_times</span><span class="p">):</span>
<span class="linenos">  37</span>    <span class="k">if</span> <span class="n">_times</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">  38</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">  39</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try Connect WiFi ... </span><span class="si">{}</span><span class="s2"> Times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_times</span><span class="p">)</span> <span class="p">)</span>
<span class="linenos">  40</span>        <span class="n">_wifi</span><span class="o">.</span><span class="n">connectWiFi</span><span class="p">(</span><span class="n">_ssid</span><span class="p">,</span> <span class="n">_pass</span><span class="p">)</span>
<span class="linenos">  41</span>        <span class="k">if</span> <span class="n">_wifi</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">  42</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">  43</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">  44</span>            <span class="k">return</span> <span class="n">try_connect_wifi</span><span class="p">(</span><span class="n">_wifi</span><span class="p">,</span> <span class="n">_ssid</span><span class="p">,</span> <span class="n">_pass</span><span class="p">,</span> <span class="n">_times</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">  45</span>    <span class="k">except</span><span class="p">:</span>
<span class="linenos">  46</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">  47</span>        <span class="k">return</span> <span class="n">try_connect_wifi</span><span class="p">(</span><span class="n">_wifi</span><span class="p">,</span> <span class="n">_ssid</span><span class="p">,</span> <span class="n">_pass</span><span class="p">,</span> <span class="n">_times</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">  48</span>
<span class="linenos">  49</span><span class="k">class</span> <span class="nc">Font</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">  50</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_address</span><span class="o">=</span><span class="mh">0x400000</span><span class="p">):</span>
<span class="linenos">  51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">font_address</span> <span class="o">=</span> <span class="n">font_address</span>
<span class="linenos">  52</span>        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<span class="linenos">  53</span>        <span class="n">esp</span><span class="o">.</span><span class="n">flash_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="linenos">  54</span>        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> \
<span class="linenos">  55</span>            <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> \
<span class="linenos">  56</span>            <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> \
<span class="linenos">  57</span>            <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> \
<span class="linenos">  58</span>            <span class="bp">self</span><span class="o">.</span><span class="n">x_height</span><span class="p">,</span> \
<span class="linenos">  59</span>            <span class="bp">self</span><span class="o">.</span><span class="n">Y_height</span><span class="p">,</span> \
<span class="linenos">  60</span>            <span class="bp">self</span><span class="o">.</span><span class="n">first_char</span><span class="p">,</span>\
<span class="linenos">  61</span>            <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;4sHHHHHHH&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="linenos">  62</span>        <span class="bp">self</span><span class="o">.</span><span class="n">first_char_info_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">font_address</span> <span class="o">+</span> <span class="mi">18</span>
<span class="linenos">  63</span>
<span class="linenos">  64</span>    <span class="k">def</span> <span class="nf">GetCharacterData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="linenos">  65</span>        <span class="n">uni</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">  66</span>        <span class="c1"># if uni not in range(self.first_char, self.last_char):</span>
<span class="linenos">  67</span>        <span class="c1">#     return None</span>
<span class="linenos">  68</span>        <span class="k">if</span> <span class="p">(</span><span class="n">uni</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_char</span> <span class="ow">or</span> <span class="n">uni</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span><span class="p">):</span>
<span class="linenos">  69</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">  70</span>        <span class="n">char_info_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_char_info_address</span> <span class="o">+</span> \
<span class="linenos">  71</span>            <span class="p">(</span><span class="n">uni</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_char</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span>
<span class="linenos">  72</span>        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="linenos">  73</span>        <span class="n">esp</span><span class="o">.</span><span class="n">flash_read</span><span class="p">(</span><span class="n">char_info_address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="linenos">  74</span>        <span class="n">ptr_char_data</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;IH&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="linenos">  75</span>        <span class="k">if</span> <span class="p">(</span><span class="n">ptr_char_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">  76</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">  77</span>        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
<span class="linenos">  78</span>        <span class="n">esp</span><span class="o">.</span><span class="n">flash_read</span><span class="p">(</span><span class="n">ptr_char_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">font_address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="linenos">  79</span>        <span class="k">return</span> <span class="n">buffer</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span>
<span class="linenos">  82</span><span class="k">class</span> <span class="nc">TextMode</span><span class="p">():</span>
<span class="linenos">  83</span>    <span class="n">normal</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">  84</span>    <span class="n">rev</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">  85</span>    <span class="n">trans</span> <span class="o">=</span> <span class="mi">3</span>
<span class="linenos">  86</span>    <span class="n">xor</span> <span class="o">=</span> <span class="mi">4</span>
<span class="linenos">  87</span>
<span class="linenos">  88</span>
<span class="linenos">  89</span><span class="k">class</span> <span class="nc">OLED</span><span class="p">(</span><span class="n">SSD1106_I2C</span><span class="p">):</span>
<span class="linenos">  90</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; 128x64 oled display &quot;&quot;&quot;</span>
<span class="linenos">  91</span>
<span class="linenos">  92</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">  93</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">i2c</span><span class="p">)</span>
<span class="linenos">  94</span>        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">Font</span><span class="p">()</span>
<span class="linenos">  95</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">  96</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;font load failed&#39;</span><span class="p">)</span>
<span class="linenos">  97</span>
<span class="linenos">  98</span>    <span class="k">def</span> <span class="nf">DispChar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">TextMode</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">auto_return</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">  99</span>            <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 100</span>            <span class="n">str_width</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 101</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 102</span>                <span class="k">return</span>
<span class="linenos"> 103</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos"> 104</span>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">GetCharacterData</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 105</span>                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 106</span>                    <span class="k">if</span> <span class="n">auto_return</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 107</span>                        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">width</span>
<span class="linenos"> 108</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 109</span>                        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
<span class="linenos"> 110</span>                    <span class="k">continue</span>
<span class="linenos"> 111</span>                <span class="n">width</span><span class="p">,</span> <span class="n">bytes_per_line</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;HH&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="linenos"> 112</span>                <span class="c1"># print(&#39;character [%d]: width = %d, bytes_per_line = %d&#39; % (ord(c)</span>
<span class="linenos"> 113</span>                <span class="c1"># , width, bytes_per_line))</span>
<span class="linenos"> 114</span>                <span class="k">if</span> <span class="n">auto_return</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 115</span>                    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">:</span>
<span class="linenos"> 116</span>                        <span class="n">str_width</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">x</span>
<span class="linenos"> 117</span>                        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 118</span>                        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos"> 119</span>                        <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">height</span>
<span class="linenos"> 120</span>                        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">height</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 121</span>                            <span class="n">y</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="linenos"> 122</span>                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
<span class="linenos"> 123</span>                    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 124</span>                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 125</span>                    <span class="k">while</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
<span class="linenos"> 126</span>                        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">bytes_per_line</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
<span class="linenos"> 127</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
<span class="linenos"> 128</span>                            <span class="n">n</span> <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 129</span>                        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 130</span>                            <span class="n">n</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">w</span>
<span class="linenos"> 131</span>                        <span class="n">py</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span>
<span class="linenos"> 132</span>                        <span class="n">page</span> <span class="o">=</span> <span class="n">py</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
<span class="linenos"> 133</span>                        <span class="n">bit</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">py</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
<span class="linenos"> 134</span>                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="linenos"> 135</span>                            <span class="n">px</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">p</span>
<span class="linenos"> 136</span>                            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 137</span>                            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 138</span>                                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">normal</span> <span class="ow">or</span> \
<span class="linenos"> 139</span>                                        <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">trans</span><span class="p">:</span>
<span class="linenos"> 140</span>                                    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 141</span>                                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
<span class="linenos"> 142</span>                                    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 143</span>                                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">xor</span><span class="p">:</span>
<span class="linenos"> 144</span>                                    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">page</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="k">if</span> <span class="n">auto_return</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="n">px</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bit</span>
<span class="linenos"> 145</span>                                    <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 146</span>                                        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 147</span>                                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 148</span>                                        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 149</span>                                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="linenos"> 150</span>                            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 151</span>                                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">normal</span><span class="p">:</span>
<span class="linenos"> 152</span>                                    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 153</span>                                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="linenos"> 154</span>                                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">TextMode</span><span class="o">.</span><span class="n">rev</span><span class="p">:</span>
<span class="linenos"> 155</span>                                    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 156</span>                                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="linenos"> 157</span>                            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="linenos"> 158</span>                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">8</span>
<span class="linenos"> 159</span>                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 160</span>                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 161</span>                <span class="n">str_width</span> <span class="o">+=</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 162</span>            <span class="k">return</span> <span class="p">(</span><span class="n">str_width</span><span class="o">-</span><span class="mi">1</span><span class="p">,(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<span class="linenos"> 163</span>
<span class="linenos"> 164</span>    <span class="k">def</span> <span class="nf">DispChar_font</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 165</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 166</span><span class="sd">        custom font display.Ref by , https://github.com/peterhinch/micropython-font-to-py</span>
<span class="linenos"> 167</span><span class="sd">        :param font:  use font_to_py.py script convert to `py` from `ttf` or `otf`.</span>
<span class="linenos"> 168</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 169</span>        <span class="n">screen_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
<span class="linenos"> 170</span>        <span class="n">screen_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
<span class="linenos"> 171</span>        <span class="n">text_row</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos"> 172</span>        <span class="n">text_col</span> <span class="o">=</span> <span class="n">y</span>
<span class="linenos"> 173</span>        <span class="n">text_length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 174</span>        <span class="k">if</span> <span class="n">font</span><span class="o">.</span><span class="n">hmap</span><span class="p">():</span>
<span class="linenos"> 175</span>            <span class="n">font_map</span> <span class="o">=</span> <span class="n">framebuf</span><span class="o">.</span><span class="n">MONO_HMSB</span> <span class="k">if</span> <span class="n">font</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="k">else</span> <span class="n">framebuf</span><span class="o">.</span><span class="n">MONO_HLSB</span>
<span class="linenos"> 176</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 177</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Font must be horizontally mapped.&#39;</span><span class="p">)</span>
<span class="linenos"> 178</span>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos"> 179</span>            <span class="n">glyph</span><span class="p">,</span> <span class="n">char_height</span><span class="p">,</span> <span class="n">char_width</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">get_ch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos"> 180</span>            <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
<span class="linenos"> 181</span>            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
<span class="linenos"> 182</span>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="linenos"> 183</span>                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="o">~</span> <span class="n">v</span>
<span class="linenos"> 184</span>            <span class="n">fbc</span> <span class="o">=</span> <span class="n">framebuf</span><span class="o">.</span><span class="n">FrameBuffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">char_width</span><span class="p">,</span> <span class="n">char_height</span><span class="p">,</span> <span class="n">font_map</span><span class="p">)</span>
<span class="linenos"> 185</span>            <span class="k">if</span> <span class="n">text_row</span> <span class="o">+</span> <span class="n">char_width</span> <span class="o">&gt;</span> <span class="n">screen_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 186</span>                <span class="n">text_length</span> <span class="o">+=</span> <span class="n">screen_width</span><span class="o">-</span><span class="n">text_row</span>
<span class="linenos"> 187</span>                <span class="n">text_row</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 188</span>                <span class="n">text_col</span> <span class="o">+=</span> <span class="n">char_height</span>
<span class="linenos"> 189</span>            <span class="k">if</span> <span class="n">text_col</span> <span class="o">+</span> <span class="n">char_height</span> <span class="o">&gt;</span> <span class="n">screen_height</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 190</span>                <span class="n">text_col</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 191</span>
<span class="linenos"> 192</span>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">fbc</span><span class="p">,</span> <span class="n">text_row</span><span class="p">,</span> <span class="n">text_col</span><span class="p">)</span>
<span class="linenos"> 193</span>            <span class="n">text_row</span> <span class="o">=</span> <span class="n">text_row</span> <span class="o">+</span> <span class="n">char_width</span><span class="o">+</span><span class="mi">1</span>
<span class="linenos"> 194</span>            <span class="n">text_length</span> <span class="o">+=</span> <span class="n">char_width</span><span class="o">+</span><span class="mi">1</span>
<span class="linenos"> 195</span>        <span class="k">return</span> <span class="p">(</span><span class="n">text_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">text_row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">text_col</span><span class="p">))</span>
<span class="linenos"> 196</span>
<span class="linenos"> 197</span><span class="c1"># display</span>
<span class="linenos"> 198</span><span class="k">if</span> <span class="mi">60</span> <span class="ow">in</span> <span class="n">i2c</span><span class="o">.</span><span class="n">scan</span><span class="p">():</span>
<span class="linenos"> 199</span>    <span class="n">oled</span> <span class="o">=</span> <span class="n">OLED</span><span class="p">()</span>
<span class="linenos"> 200</span>    <span class="n">display</span> <span class="o">=</span> <span class="n">oled</span>
<span class="linenos"> 201</span><span class="k">else</span><span class="p">:</span>
<span class="linenos"> 202</span>    <span class="k">pass</span>
<span class="linenos"> 203</span>
<span class="linenos"> 204</span><span class="k">class</span> <span class="nc">MOTION</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos"> 205</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 206</span>        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span>
<span class="linenos"> 207</span>        <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
<span class="linenos"> 208</span>        <span class="k">if</span> <span class="mi">38</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
<span class="linenos"> 209</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># MSA300</span>
<span class="linenos"> 210</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">IIC_ADDR</span> <span class="o">=</span> <span class="mi">38</span>
<span class="linenos"> 211</span>        <span class="k">elif</span> <span class="mi">107</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
<span class="linenos"> 212</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># QMI8658</span>
<span class="linenos"> 213</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">IIC_ADDR</span> <span class="o">=</span> <span class="mi">107</span>
<span class="linenos"> 214</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 215</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;MOTION init error&quot;</span><span class="p">)</span>
<span class="linenos"> 216</span>        <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 217</span>            <span class="k">pass</span>
<span class="linenos"> 218</span>        <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 219</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="c1"># soft reset regist value.</span>
<span class="linenos"> 220</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="linenos"> 221</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span> <span class="c1"># Enabe reg address auto increment auto</span>
<span class="linenos"> 222</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span> <span class="c1"># Enable accel and gyro</span>
<span class="linenos"> 223</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="c1"># accel range:4g ODR 128HZ</span>
<span class="linenos"> 224</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="c1"># gyro ODR 8000HZ, FS 256dps</span>
<span class="linenos"> 225</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">)</span> <span class="c1"># Enable accel and gyro Low-Pass Filter</span>
<span class="linenos"> 226</span>        <span class="c1"># print(&#39;Motion init finished!&#39;)</span>
<span class="linenos"> 227</span>
<span class="linenos"> 228</span>    <span class="c1"># @staticmethod</span>
<span class="linenos"> 229</span>    <span class="k">def</span> <span class="nf">_readReg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">nbytes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 230</span>        <span class="k">return</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">IIC_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="linenos"> 231</span>
<span class="linenos"> 232</span>    <span class="c1"># @staticmethod</span>
<span class="linenos"> 233</span>    <span class="k">def</span> <span class="nf">_writeReg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 234</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">IIC_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>
<span class="linenos"> 235</span>
<span class="linenos"> 236</span>    <span class="k">def</span> <span class="nf">get_fw_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 237</span>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 238</span>            <span class="k">pass</span>
<span class="linenos"> 239</span>        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 240</span>            <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="c1"># send ctrl9R read FW cmd</span>
<span class="linenos"> 241</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 242</span>                <span class="k">if</span> <span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x2F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0X01</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0X01</span><span class="p">:</span>
<span class="linenos"> 243</span>                    <span class="k">break</span>
<span class="linenos"> 244</span>            <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0X49</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos"> 245</span>            <span class="c1"># print(buf[0])</span>
<span class="linenos"> 246</span>            <span class="c1"># print(buf[1])</span>
<span class="linenos"> 247</span>            <span class="c1"># print(buf[2])</span>
<span class="linenos"> 248</span>        
<span class="linenos"> 249</span>    <span class="k">class</span> <span class="nc">Accelerometer</span><span class="p">():</span>
<span class="linenos"> 250</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;MSA300&quot;&quot;&quot;</span>
<span class="linenos"> 251</span>        <span class="c1"># Range and resolustion</span>
<span class="linenos"> 252</span>        <span class="n">RANGE_2G</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 253</span>        <span class="n">RANGE_4G</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 254</span>        <span class="n">RANGE_8G</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 255</span>        <span class="n">RANGE_16G</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos"> 256</span>        <span class="n">RES_14_BIT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
<span class="linenos"> 257</span>        <span class="n">RES_12_BIT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 258</span>        <span class="n">RES_10_BIT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 259</span>        <span class="c1"># Event</span>
<span class="linenos"> 260</span>        <span class="n">TILT_LEFT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 261</span>        <span class="n">TILT_RIGHT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 262</span>        <span class="n">TILT_UP</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 263</span>        <span class="n">TILT_DOWN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos"> 264</span>        <span class="n">FACE_UP</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 265</span>        <span class="n">FACE_DOWN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 266</span>        <span class="n">SINGLE_CLICK</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 267</span>        <span class="n">DOUBLE_CLICK</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="linenos"> 268</span>        <span class="n">FREEFALL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="linenos"> 269</span>
<span class="linenos"> 270</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;QMI8658C&quot;&quot;&quot;</span>
<span class="linenos"> 271</span>        <span class="c1"># Range and resolustion</span>
<span class="linenos"> 272</span>        <span class="c1"># QMI8658C_RANGE_2G = const(0x00)</span>
<span class="linenos"> 273</span>        <span class="c1"># QMI8658C_RANGE_4G = const(0x10)</span>
<span class="linenos"> 274</span>        <span class="c1"># QMI8658C_RANGE_8G = const(0x20)</span>
<span class="linenos"> 275</span>        <span class="c1"># QMI8658C_RANGE_16G = const(0x40)</span>
<span class="linenos"> 276</span>
<span class="linenos"> 277</span>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 278</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 279</span>                <span class="bp">self</span><span class="o">.</span><span class="n">set_resolution</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">Accelerometer</span><span class="o">.</span><span class="n">RES_10_BIT</span><span class="p">)</span>
<span class="linenos"> 280</span>                <span class="bp">self</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">Accelerometer</span><span class="o">.</span><span class="n">RANGE_2G</span><span class="p">)</span>
<span class="linenos"> 281</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span>               <span class="c1"># polarity of y,z axis,</span>
<span class="linenos"> 282</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>                  <span class="c1"># set power mode = normal</span>
<span class="linenos"> 283</span>                <span class="c1"># interrupt</span>
<span class="linenos"> 284</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">)</span>      <span class="c1"># int enabled: Orient | S_TAP | D_TAP </span>
<span class="linenos"> 285</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span>      <span class="c1"># int enabled: Freefall</span>
<span class="linenos"> 286</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">)</span>      <span class="c1"># int1 map to: Orient, S_TAP, D_TAP, Freefall</span>
<span class="linenos"> 287</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span>      <span class="c1"># int1 active level = 0, output = OD</span>
<span class="linenos"> 288</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span>      <span class="c1"># int tempoary latched 25ms</span>
<span class="linenos"> 289</span>                <span class="c1"># freefall:</span>
<span class="linenos"> 290</span>                <span class="c1">#   single mode: |acc_x| &lt; Threshold &amp;&amp; |acc_y| &lt; Threshold &amp;&amp; |acc_z| &lt; Threshold, at least time &gt; Duration</span>
<span class="linenos"> 291</span>                <span class="c1">#   sum mode: |acc_x| + |acc_y| + |acc_z| &lt; Threshold, at least time &gt; Duration</span>
<span class="linenos"> 292</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>    <span class="c1"># Freefall Duration:(n+1)*2ms, range from 2ms to 512ms</span>
<span class="linenos"> 293</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>    <span class="c1"># Freefall Threshold: n*7.81mg</span>
<span class="linenos"> 294</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span>  <span class="c1"># Freefall mode = 0-singlemode;hysteresis = n*125mg</span>
<span class="linenos"> 295</span>                <span class="c1"># tap:</span>
<span class="linenos"> 296</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">)</span>  <span class="c1"># Tap duration:quit = 30ms, shock=50ms, time window for secent shock=500ms</span>
<span class="linenos"> 297</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">)</span>  <span class="c1"># Tap threshold = 10*[62.5mg@2G | 125mg@4G | 250mg@8G | 500mg@16g]</span>
<span class="linenos"> 298</span>                <span class="c1"># Orient</span>
<span class="linenos"> 299</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>  <span class="c1"># Orient hysteresis= 1*62.5mg; </span>
<span class="linenos"> 300</span>                                            <span class="c1">#        block mode = 10 z_axis blocking or slope in any axis &gt; 0.2g;</span>
<span class="linenos"> 301</span>                                            <span class="c1">#        orient mode = 00-symetrical</span>
<span class="linenos"> 302</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x2D</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>     <span class="c1"># Z-axis block</span>
<span class="linenos"> 303</span>                <span class="c1"># int pin irq register</span>
<span class="linenos"> 304</span>                <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos"> 305</span>                <span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_FALLING</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irq</span><span class="p">)</span>
<span class="linenos"> 306</span>                <span class="c1"># event handler </span>
<span class="linenos"> 307</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_up</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 308</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_down</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 309</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_left</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 310</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_right</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 311</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_face_up</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 312</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_face_down</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 313</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_single_click</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 314</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_double_click</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 315</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_freefall</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 316</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 317</span>                <span class="c1"># 设置偏移值</span>
<span class="linenos"> 318</span>                <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 319</span>                <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 320</span>                <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 321</span>                <span class="bp">self</span><span class="o">.</span><span class="n">get_nvs_offset</span><span class="p">()</span>
<span class="linenos"> 322</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 323</span>                    <span class="nb">id</span> <span class="o">=</span>  <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 324</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 325</span>                    <span class="k">pass</span>
<span class="linenos"> 326</span>                <span class="bp">self</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">Accelerometer</span><span class="o">.</span><span class="n">RANGE_2G</span><span class="p">)</span> <span class="c1">#设置默认分辨率+-2g</span>
<span class="linenos"> 327</span>                <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="linenos"> 328</span>                <span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_FALLING</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irq</span><span class="p">)</span>
<span class="linenos"> 329</span>                <span class="c1"># event handler </span>
<span class="linenos"> 330</span>                <span class="bp">self</span><span class="o">.</span><span class="n">wom</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 331</span>            
<span class="linenos"> 332</span>
<span class="linenos"> 333</span>        <span class="k">def</span> <span class="nf">irq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="linenos"> 334</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 335</span>                <span class="n">reg_int</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x09</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 336</span>                <span class="n">reg_orent</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 337</span>                <span class="c1"># orient_int</span>
<span class="linenos"> 338</span>                <span class="k">if</span> <span class="p">(</span><span class="n">reg_int</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">):</span>
<span class="linenos"> 339</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 340</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILT_LEFT</span><span class="p">)</span>
<span class="linenos"> 341</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 342</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILT_RIGHT</span><span class="p">)</span>
<span class="linenos"> 343</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_up</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 344</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILT_UP</span><span class="p">)</span>
<span class="linenos"> 345</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_down</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 346</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_tilt_down</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILT_DOWN</span><span class="p">)</span>
<span class="linenos"> 347</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_face_up</span><span class="p">):</span>
<span class="linenos"> 348</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_face_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FACE_UP</span><span class="p">)</span>
<span class="linenos"> 349</span>                    <span class="k">if</span> <span class="p">((</span><span class="n">reg_orent</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_face_down</span><span class="p">):</span>
<span class="linenos"> 350</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_face_down</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FACE_DOWN</span><span class="p">)</span>
<span class="linenos"> 351</span>                <span class="c1"># single tap</span>
<span class="linenos"> 352</span>                <span class="k">if</span> <span class="p">(</span><span class="n">reg_int</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">):</span>
<span class="linenos"> 353</span>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_single_click</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 354</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_single_click</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SINGLE_CLICK</span><span class="p">)</span>
<span class="linenos"> 355</span>                <span class="c1"># double tap</span>
<span class="linenos"> 356</span>                <span class="k">if</span> <span class="p">(</span><span class="n">reg_int</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">):</span>
<span class="linenos"> 357</span>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_double_click</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 358</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_double_click</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOUBLE_CLICK</span><span class="p">)</span>
<span class="linenos"> 359</span>                <span class="c1"># freefall</span>
<span class="linenos"> 360</span>                <span class="k">if</span> <span class="p">(</span><span class="n">reg_int</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
<span class="linenos"> 361</span>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_freefall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 362</span>                        <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_freefall</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FREEFALL</span><span class="p">)</span>
<span class="linenos"> 363</span>                <span class="c1"># print(&quot;acc sensor interrupt, because 0x%2x, orient = 0x%2x&quot; % (reg_int, reg_orent))</span>
<span class="linenos"> 364</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>  
<span class="linenos"> 365</span>                <span class="n">flag</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x2F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 366</span>                <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">:</span>
<span class="linenos"> 367</span>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wom int trigged.&#39;</span><span class="p">)</span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span>        <span class="k">def</span> <span class="nf">wom_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 370</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 371</span>                <span class="k">pass</span>
<span class="linenos"> 372</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 373</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="c1"># soft reset regist value.</span>
<span class="linenos"> 374</span>                <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="linenos"> 375</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="c1"># disable all sensor</span>
<span class="linenos"> 376</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="c1"># accel range:4g ODR 128HZ</span>
<span class="linenos"> 377</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xfF</span><span class="p">)</span> <span class="c1"># CAL_L WoM Threshold(1mg/LSB resolution)</span>
<span class="linenos"> 378</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">)</span> <span class="c1"># CAL_H WoM (INT1 blank time 0x1f)</span>
<span class="linenos"> 379</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span>
<span class="linenos"> 380</span>                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 381</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x2F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0X01</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0X01</span><span class="p">:</span>
<span class="linenos"> 382</span>                        <span class="k">break</span>
<span class="linenos"> 383</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="c1"># enable accel</span>
<span class="linenos"> 384</span>
<span class="linenos"> 385</span>        <span class="k">def</span> <span class="nf">set_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span><span class="c1"># set data output rate</span>
<span class="linenos"> 386</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 387</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 388</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xC</span>
<span class="linenos"> 389</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 390</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 391</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 392</span>                <span class="bp">self</span><span class="o">.</span><span class="n">odr</span> <span class="o">=</span> <span class="n">resolution</span>
<span class="linenos"> 393</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 394</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span>
<span class="linenos"> 395</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span>
<span class="linenos"> 396</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 397</span>                
<span class="linenos"> 398</span>        <span class="k">def</span> <span class="nf">set_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">range</span><span class="p">):</span>
<span class="linenos"> 399</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 400</span>                <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="nb">range</span>
<span class="linenos"> 401</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 402</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span>
<span class="linenos"> 403</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="nb">range</span>
<span class="linenos"> 404</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x0f</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 405</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 406</span>                <span class="k">if</span><span class="p">(</span><span class="nb">range</span><span class="o">==</span><span class="mi">3</span><span class="p">):</span>
<span class="linenos"> 407</span>                    <span class="nb">range</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1">#0x40</span>
<span class="linenos"> 408</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 409</span>                    <span class="nb">range</span> <span class="o">=</span> <span class="nb">range</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="linenos"> 410</span>                <span class="bp">self</span><span class="o">.</span><span class="n">FS</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="nb">range</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
<span class="linenos"> 411</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 412</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8F</span>
<span class="linenos"> 413</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="nb">range</span>
<span class="linenos"> 414</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 415</span>
<span class="linenos"> 416</span>        <span class="k">def</span> <span class="nf">set_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 417</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 418</span>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="linenos"> 419</span>                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 420</span>                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 421</span>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;out of range,only offset 1 gravity&quot;</span><span class="p">)</span>
<span class="linenos"> 422</span>                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 423</span>                    <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x39</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mf">0.0039</span><span class="p">)))</span>
<span class="linenos"> 424</span>                <span class="k">elif</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 425</span>                    <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mf">0.0039</span><span class="p">)))</span>
<span class="linenos"> 426</span>                <span class="k">elif</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 427</span>                    <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x3A</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mf">0.0039</span><span class="p">)))</span>
<span class="linenos"> 428</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 429</span>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="linenos"> 430</span>                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 431</span>                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">16</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
<span class="linenos"> 432</span>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;超出调整范围!!!&quot;</span><span class="p">)</span>
<span class="linenos"> 433</span>                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 434</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos"> 435</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="linenos"> 436</span>                <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 437</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">y</span>
<span class="linenos"> 438</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="linenos"> 439</span>                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 440</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="n">z</span>
<span class="linenos"> 441</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="linenos"> 442</span>                
<span class="linenos"> 443</span>        <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 444</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 445</span>                <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 446</span>                <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 447</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 448</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 449</span>                        <span class="n">x</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 450</span>                        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span>
<span class="linenos"> 451</span>                    <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 452</span>                        <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 453</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 454</span>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 455</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 456</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x35</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 457</span>                <span class="n">x</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 458</span>                <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span>
<span class="linenos"> 459</span>
<span class="linenos"> 460</span>        <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 461</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 462</span>                <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 463</span>                <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 464</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 465</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 466</span>                        <span class="n">y</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 467</span>                        <span class="k">return</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span>
<span class="linenos"> 468</span>                    <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 469</span>                        <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 470</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 471</span>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 472</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 473</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x37</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 474</span>                <span class="n">y</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 475</span>                <span class="k">return</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span>
<span class="linenos"> 476</span>
<span class="linenos"> 477</span>        <span class="k">def</span> <span class="nf">get_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 478</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 479</span>                <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 480</span>                <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 481</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 482</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 483</span>                        <span class="n">z</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 484</span>                        <span class="k">return</span> <span class="n">z</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">4096</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span>
<span class="linenos"> 485</span>                    <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 486</span>                        <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 487</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 488</span>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 489</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 490</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x39</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 491</span>                <span class="n">z</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 492</span>                <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span>
<span class="linenos"> 493</span>                <span class="c1"># return -(z * self.FS) / 32768</span>
<span class="linenos"> 494</span>     
<span class="linenos"> 495</span>        <span class="k">def</span> <span class="nf">roll_pitch_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 496</span>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">()</span>
<span class="linenos"> 497</span>            <span class="c1"># vector normalize</span>
<span class="linenos"> 498</span>            <span class="n">mag</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="o">+</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 499</span>            <span class="n">x</span> <span class="o">/=</span> <span class="n">mag</span>
<span class="linenos"> 500</span>            <span class="n">y</span> <span class="o">/=</span> <span class="n">mag</span>
<span class="linenos"> 501</span>            <span class="n">z</span> <span class="o">/=</span> <span class="n">mag</span>
<span class="linenos"> 502</span>            <span class="n">roll</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="linenos"> 503</span>            <span class="n">pitch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span>            <span class="k">return</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span>
<span class="linenos"> 506</span>        
<span class="linenos"> 507</span>        <span class="k">def</span> <span class="nf">get_nvs_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 508</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 509</span>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">NVS</span><span class="p">(</span><span class="s2">&quot;offset_a&quot;</span><span class="p">)</span>
<span class="linenos"> 510</span>                <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 511</span>                <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 512</span>                <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 513</span>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 514</span>                <span class="c1"># print(&#39;Accelerometer get_nvs_offset:&#39;,e)</span>
<span class="linenos"> 515</span>                <span class="c1"># self.x_offset = 0</span>
<span class="linenos"> 516</span>                <span class="c1"># self.y_offset = 0</span>
<span class="linenos"> 517</span>                <span class="c1"># self.z_offset = 0</span>
<span class="linenos"> 518</span>                <span class="bp">self</span><span class="o">.</span><span class="n">set_offset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 519</span>        
<span class="linenos"> 520</span>        <span class="k">def</span> <span class="nf">set_nvs_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 521</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 522</span>                <span class="n">nvs</span> <span class="o">=</span> <span class="n">NVS</span><span class="p">(</span><span class="s2">&quot;offset_a&quot;</span><span class="p">)</span>
<span class="linenos"> 523</span>                <span class="n">nvs</span><span class="o">.</span><span class="n">set_i32</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="mf">1e5</span><span class="p">))</span>
<span class="linenos"> 524</span>                <span class="n">nvs</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos"> 525</span>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 526</span>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gyroscope set_nvs_offset error:&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 527</span>
<span class="linenos"> 528</span>    <span class="k">class</span> <span class="nc">Gyroscope</span><span class="p">():</span>
<span class="linenos"> 529</span>        <span class="c1"># gyro full scale</span>
<span class="linenos"> 530</span>        <span class="n">RANGE_16_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
<span class="linenos"> 531</span>        <span class="n">RANGE_32_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
<span class="linenos"> 532</span>        <span class="n">RANGE_64_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
<span class="linenos"> 533</span>        <span class="n">RANGE_128_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>
<span class="linenos"> 534</span>        <span class="n">RANGE_256_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>
<span class="linenos"> 535</span>        <span class="n">RANGE_512_DPS</span> <span class="o">=</span>  <span class="n">const</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span>
<span class="linenos"> 536</span>        <span class="n">RANGE_1024_DPS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
<span class="linenos"> 537</span>        <span class="n">RANGE_2048_DPS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>
<span class="linenos"> 538</span>
<span class="linenos"> 539</span>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 540</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 541</span>                <span class="k">pass</span>
<span class="linenos"> 542</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 543</span>                <span class="c1"># 设置偏移值</span>
<span class="linenos"> 544</span>                <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 545</span>                <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 546</span>                <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 547</span>                <span class="bp">self</span><span class="o">.</span><span class="n">get_nvs_offset</span><span class="p">()</span>
<span class="linenos"> 548</span>                <span class="bp">self</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">Gyroscope</span><span class="o">.</span><span class="n">RANGE_256_DPS</span><span class="p">)</span>
<span class="linenos"> 549</span>
<span class="linenos"> 550</span>        <span class="k">def</span> <span class="nf">set_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">range</span><span class="p">):</span>
<span class="linenos"> 551</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 552</span>                <span class="k">pass</span>
<span class="linenos"> 553</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 554</span>                <span class="bp">self</span><span class="o">.</span><span class="n">FS</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="nb">range</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>        
<span class="linenos"> 555</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 556</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8F</span>
<span class="linenos"> 557</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="nb">range</span>
<span class="linenos"> 558</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 559</span>
<span class="linenos"> 560</span>        <span class="k">def</span> <span class="nf">set_ODR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">odr</span><span class="p">):</span>  <span class="c1"># set data output rate</span>
<span class="linenos"> 561</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 562</span>                <span class="k">pass</span>
<span class="linenos"> 563</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 564</span>                <span class="bp">self</span><span class="o">.</span><span class="n">odr</span> <span class="o">=</span> <span class="n">odr</span>
<span class="linenos"> 565</span>                <span class="nb">format</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 566</span>                <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF0</span>
<span class="linenos"> 567</span>                <span class="nb">format</span> <span class="o">|=</span> <span class="n">odr</span>
<span class="linenos"> 568</span>                <span class="n">MOTION</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="linenos"> 569</span>
<span class="linenos"> 570</span>        <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 571</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 572</span>                <span class="k">pass</span>
<span class="linenos"> 573</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 574</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 575</span>                <span class="n">x</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 576</span>                <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span>
<span class="linenos"> 577</span>
<span class="linenos"> 578</span>        <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 579</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 580</span>                <span class="k">pass</span>
<span class="linenos"> 581</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 582</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x3d</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 583</span>                <span class="n">y</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 584</span>                <span class="k">return</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span>
<span class="linenos"> 585</span>
<span class="linenos"> 586</span>        <span class="k">def</span> <span class="nf">get_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 587</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 588</span>                <span class="k">pass</span>
<span class="linenos"> 589</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 590</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">MOTION</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 591</span>                <span class="n">z</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 592</span>                <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">FS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span>
<span class="linenos"> 593</span>        
<span class="linenos"> 594</span>        <span class="k">def</span> <span class="nf">set_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 595</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 596</span>                <span class="k">pass</span>
<span class="linenos"> 597</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 598</span>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="linenos"> 599</span>                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 600</span>                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">4096</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
<span class="linenos"> 601</span>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;超出调整范围!!!&quot;</span><span class="p">)</span>
<span class="linenos"> 602</span>                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 603</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">x</span>
<span class="linenos"> 604</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="linenos"> 605</span>                <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 606</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">y</span>
<span class="linenos"> 607</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="linenos"> 608</span>                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 609</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="n">z</span>
<span class="linenos"> 610</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_nvs_offset</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span>        <span class="k">def</span> <span class="nf">get_nvs_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 613</span>            <span class="k">if</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 614</span>                <span class="k">pass</span>
<span class="linenos"> 615</span>            <span class="k">elif</span><span class="p">(</span><span class="n">MOTION</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 616</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 617</span>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">NVS</span><span class="p">(</span><span class="s2">&quot;offset_g&quot;</span><span class="p">)</span>
<span class="linenos"> 618</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 619</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 620</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">get_i32</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 621</span>                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 622</span>                    <span class="c1"># print(&#39;Gyroscope get_nvs_offset:&#39;,e)</span>
<span class="linenos"> 623</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_offset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 624</span>                    <span class="c1"># self.x_offset = 0</span>
<span class="linenos"> 625</span>                    <span class="c1"># self.y_offset = 0</span>
<span class="linenos"> 626</span>                    <span class="c1"># self.z_offset = 0</span>
<span class="linenos"> 627</span>
<span class="linenos"> 628</span>        <span class="k">def</span> <span class="nf">set_nvs_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 629</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 630</span>                <span class="n">nvs</span> <span class="o">=</span> <span class="n">NVS</span><span class="p">(</span><span class="s2">&quot;offset_g&quot;</span><span class="p">)</span>
<span class="linenos"> 631</span>                <span class="n">nvs</span><span class="o">.</span><span class="n">set_i32</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="mf">1e5</span><span class="p">))</span>
<span class="linenos"> 632</span>                <span class="n">nvs</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos"> 633</span>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 634</span>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gyroscope set_nvs_offset error:&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 635</span>
<span class="linenos"> 636</span>    
<span class="linenos"> 637</span><span class="n">motion</span> <span class="o">=</span> <span class="n">MOTION</span><span class="p">()</span>
<span class="linenos"> 638</span><span class="n">accelerometer</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">Accelerometer</span><span class="p">()</span>
<span class="linenos"> 639</span><span class="n">gyroscope</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">Gyroscope</span><span class="p">()</span>
<span class="linenos"> 640</span>
<span class="linenos"> 641</span><span class="k">class</span> <span class="nc">Magnetic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos"> 642</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; MMC5983MA driver &quot;&quot;&quot;</span>
<span class="linenos"> 643</span><span class="w">    </span><span class="sd">&quot;&quot;&quot; MMC5603NJ driver 20211028替换&quot;&quot;&quot;</span>
<span class="linenos"> 644</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 645</span>        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">48</span>
<span class="linenos"> 646</span>        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span>
<span class="linenos"> 647</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_judge_id</span><span class="p">()</span>
<span class="linenos"> 648</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos"> 649</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_ID</span><span class="o">==</span><span class="mi">48</span><span class="p">):</span>
<span class="linenos"> 650</span>            <span class="k">pass</span>  <span class="c1"># MMC5983MA</span>
<span class="linenos"> 651</span>        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_ID</span><span class="o">==</span><span class="mi">16</span><span class="p">):</span>
<span class="linenos"> 652</span>            <span class="k">pass</span>  <span class="c1"># MMC5603NJ</span>
<span class="linenos"> 653</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 654</span>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Magnetic init error&quot;</span><span class="p">)</span>
<span class="linenos"> 655</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; MMC5983MA driver &quot;&quot;&quot;</span>
<span class="linenos"> 656</span>        <span class="c1"># 传量器裸数据，乘0.25后转化为mGS</span>
<span class="linenos"> 657</span>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 658</span>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 659</span>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 660</span>        <span class="c1"># 校准后的偏移量, 基于裸数据</span>
<span class="linenos"> 661</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span> <span class="o">=</span> <span class="mf">0.0</span> 
<span class="linenos"> 662</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 663</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_z</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 664</span>        <span class="c1"># 去皮偏移量，类似电子秤去皮功能，基于裸数据。</span>
<span class="linenos"> 665</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 666</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 667</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 668</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_peeling</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 669</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 670</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x20\xbd\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 671</span><span class="w">        </span><span class="sd">&quot;&quot;&quot; MMC5603NJ driver &quot;&quot;&quot;</span>
<span class="linenos"> 672</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 673</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span><span class="c1">#软件复位</span>
<span class="linenos"> 674</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 675</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x1A</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="linenos"> 676</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x1B</span><span class="p">,</span> <span class="mb">0b10100001</span><span class="p">)</span>
<span class="linenos"> 677</span>            <span class="c1"># self._writeReg(0x1C, 0b00000011)</span>
<span class="linenos"> 678</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x1C</span><span class="p">,</span> <span class="mb">0b00000000</span><span class="p">)</span>
<span class="linenos"> 679</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_writeReg</span><span class="p">(</span><span class="mh">0x1D</span><span class="p">,</span> <span class="mb">0b10010000</span><span class="p">)</span>
<span class="linenos"> 680</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 681</span>
<span class="linenos"> 682</span>    <span class="k">def</span> <span class="nf">_readReg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nbytes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 683</span>        <span class="k">return</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="linenos"> 684</span>
<span class="linenos"> 685</span>    <span class="k">def</span> <span class="nf">_writeReg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 686</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto_mem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span> 
<span class="linenos"> 687</span>
<span class="linenos"> 688</span>    <span class="k">def</span> <span class="nf">_set_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 689</span>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 690</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#set</span>
<span class="linenos"> 691</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 692</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 693</span>                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 694</span>                <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 695</span>                <span class="n">status</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 696</span>                <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
<span class="linenos"> 697</span>                    <span class="k">break</span>
<span class="linenos"> 698</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 699</span>            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 700</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;3H&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos"> 701</span>
<span class="linenos"> 702</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x10</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#reset</span>
<span class="linenos"> 703</span>
<span class="linenos"> 704</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 705</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 706</span>                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 707</span>                <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 708</span>                <span class="n">status</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 709</span>                <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
<span class="linenos"> 710</span>                    <span class="k">break</span>
<span class="linenos"> 711</span>            <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 712</span>            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 713</span>            <span class="n">data1</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;3H&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos"> 714</span>
<span class="linenos"> 715</span>            <span class="bp">self</span><span class="o">.</span><span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">data1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
<span class="linenos"> 716</span>            <span class="bp">self</span><span class="o">.</span><span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">data1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
<span class="linenos"> 717</span>            <span class="bp">self</span><span class="o">.</span><span class="n">z_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">data1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
<span class="linenos"> 718</span>        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 719</span>            <span class="k">pass</span>
<span class="linenos"> 720</span>    
<span class="linenos"> 721</span>    <span class="k">def</span> <span class="nf">_get_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 722</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 723</span>            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 724</span>            <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 725</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 726</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#set</span>
<span class="linenos"> 727</span>
<span class="linenos"> 728</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 729</span>                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 730</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 731</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 732</span>                        <span class="n">status</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 733</span>                        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
<span class="linenos"> 734</span>                            <span class="k">break</span>
<span class="linenos"> 735</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 736</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 737</span>                    <span class="n">data</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;3H&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos"> 738</span>
<span class="linenos"> 739</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x10</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#reset</span>
<span class="linenos"> 740</span>
<span class="linenos"> 741</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 742</span>                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 743</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 744</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 745</span>                        <span class="n">status</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 746</span>                        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
<span class="linenos"> 747</span>                            <span class="k">break</span>
<span class="linenos"> 748</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 749</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="linenos"> 750</span>                    <span class="n">data1</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;3H&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="linenos"> 751</span>
<span class="linenos"> 752</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">data1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 753</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 754</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">data1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 755</span>                    <span class="c1"># print(str(self.raw_x) + &quot;   &quot; + str(self.raw_y) + &quot;  &quot; + str(self.raw_z))</span>
<span class="linenos"> 756</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 757</span>                    <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 758</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 759</span>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>     
<span class="linenos"> 760</span>        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 761</span>            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 762</span>            <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 763</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 764</span>                    <span class="n">_raw_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 765</span>                    <span class="n">_raw_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 766</span>                    <span class="n">_raw_z</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 767</span>
<span class="linenos"> 768</span>                    <span class="c1"># self.i2c.writeto(self.addr, b&#39;\x1B\x08&#39;, True)  #set</span>
<span class="linenos"> 769</span>                    <span class="c1"># self.i2c.writeto(self.addr, b&#39;\x1B\x01&#39;, True)</span>
<span class="linenos"> 770</span>                    
<span class="linenos"> 771</span>                    <span class="c1"># while True:</span>
<span class="linenos"> 772</span>                    <span class="c1">#     buf = self._readReg(0x18, 1)</span>
<span class="linenos"> 773</span>                    <span class="c1">#     status = buf[0]</span>
<span class="linenos"> 774</span>                    <span class="c1">#     if(status &amp; 0x40):</span>
<span class="linenos"> 775</span>                    <span class="c1">#         break</span>
<span class="linenos"> 776</span>
<span class="linenos"> 777</span>                    <span class="c1"># _buf = self._readReg(0x00, 9)</span>
<span class="linenos"> 778</span>
<span class="linenos"> 779</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1B\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#set</span>
<span class="linenos"> 780</span>                    <span class="c1"># self.i2c.writeto(self.addr, b&#39;\x1B\x80&#39;, True)</span>
<span class="linenos"> 781</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1B\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 782</span>                    
<span class="linenos"> 783</span>                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 784</span>                        <span class="n">sleep_ms</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="linenos"> 785</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 786</span>                        <span class="n">status</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 787</span>                        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">):</span>
<span class="linenos"> 788</span>                            <span class="k">break</span>
<span class="linenos"> 789</span>
<span class="linenos"> 790</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readReg</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="linenos"> 791</span>
<span class="linenos"> 792</span>                    <span class="n">_raw_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 793</span>                    <span class="n">_raw_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 794</span>                    <span class="n">_raw_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 795</span>
<span class="linenos"> 796</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">=</span> <span class="n">_raw_x</span>
<span class="linenos"> 797</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">=</span> <span class="n">_raw_y</span>
<span class="linenos"> 798</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">=</span> <span class="n">_raw_z</span>
<span class="linenos"> 799</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 800</span>                    <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 801</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 802</span>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 803</span>
<span class="linenos"> 804</span>    <span class="k">def</span> <span class="nf">peeling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 805</span><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="linenos"> 806</span><span class="sd">        去除磁场环境</span>
<span class="linenos"> 807</span><span class="sd">        &#39;&#39;&#39;</span>
<span class="linenos"> 808</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 809</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span>
<span class="linenos"> 810</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span>
<span class="linenos"> 811</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span>
<span class="linenos"> 812</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_peeling</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 813</span>
<span class="linenos"> 814</span>    <span class="k">def</span> <span class="nf">clear_peeling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 815</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 816</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 817</span>        <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="linenos"> 818</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_peeling</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 819</span>
<span class="linenos"> 820</span>    <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 821</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 822</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 823</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">*</span> <span class="mf">0.25</span>
<span class="linenos"> 824</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 825</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 826</span>            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span><span class="p">):</span>
<span class="linenos"> 827</span>                <span class="k">return</span> <span class="o">-</span><span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span><span class="p">)</span>
<span class="linenos"> 828</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 829</span>                <span class="k">return</span> <span class="o">-</span><span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="mi">524288</span><span class="p">)</span>
<span class="linenos"> 830</span>            <span class="c1"># return -(self.raw_x - 524288)/16384</span>
<span class="linenos"> 831</span>
<span class="linenos"> 832</span>    <span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 833</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 834</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 835</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">*</span> <span class="mf">0.25</span>
<span class="linenos"> 836</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 837</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 838</span>            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span><span class="p">):</span>
<span class="linenos"> 839</span>                <span class="k">return</span> <span class="o">-</span><span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span><span class="p">)</span>
<span class="linenos"> 840</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 841</span>                <span class="k">return</span> <span class="o">-</span><span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="mi">524288</span><span class="p">)</span>
<span class="linenos"> 842</span>            <span class="c1"># return -(self.raw_y - 524288)/16384</span>
<span class="linenos"> 843</span>
<span class="linenos"> 844</span>    <span class="k">def</span> <span class="nf">get_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 845</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 846</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 847</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">*</span> <span class="mf">0.25</span> 
<span class="linenos"> 848</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 849</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 850</span>            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_z</span><span class="p">):</span>
<span class="linenos"> 851</span>                <span class="k">return</span> <span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_z</span><span class="p">)</span>
<span class="linenos"> 852</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 853</span>                <span class="k">return</span> <span class="mf">0.0625</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">-</span> <span class="mi">524288</span><span class="p">)</span>
<span class="linenos"> 854</span>            <span class="c1"># return (self.raw_z - 524288)/16384</span>
<span class="linenos"> 855</span>
<span class="linenos"> 856</span>    <span class="k">def</span> <span class="nf">get_field_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 857</span>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 858</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 859</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_peeling</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 860</span>                <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span><span class="p">)))</span><span class="o">*</span><span class="mf">0.25</span>
<span class="linenos"> 861</span>            <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span><span class="p">))</span><span class="o">*</span><span class="mf">0.25</span>
<span class="linenos"> 862</span>        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 863</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 864</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_peeling</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 865</span>                <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peeling_z</span> <span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="mf">0.0625</span>
<span class="linenos"> 866</span>            <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_z</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)))</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 869</span>        <span class="n">oled</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 870</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;步骤1:&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 871</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;如图&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 872</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;转几周&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 873</span>        <span class="n">oled</span><span class="o">.</span><span class="n">bitmap</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">calibrate_img</span><span class="o">.</span><span class="n">rotate</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 874</span>        <span class="n">oled</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos"> 875</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 876</span>        <span class="n">min_x</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span>
<span class="linenos"> 877</span>        <span class="n">min_y</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span>
<span class="linenos"> 878</span>        <span class="n">min_z</span> <span class="o">=</span> <span class="n">max_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span>
<span class="linenos"> 879</span>        <span class="n">ticks_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ticks_ms</span><span class="p">()</span>
<span class="linenos"> 880</span>        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ticks_diff</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ticks_ms</span><span class="p">(),</span> <span class="n">ticks_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">)</span> <span class="p">:</span>
<span class="linenos"> 881</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 882</span>            <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span><span class="p">,</span> <span class="n">min_x</span><span class="p">)</span>
<span class="linenos"> 883</span>            <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span><span class="p">,</span> <span class="n">min_y</span><span class="p">)</span>
<span class="linenos"> 884</span>            <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">)</span>
<span class="linenos"> 885</span>            <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">)</span>
<span class="linenos"> 886</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 887</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos"> 888</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos"> 889</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cali_offset_x: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  cali_offset_y: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span><span class="p">))</span>
<span class="linenos"> 890</span>        <span class="n">oled</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 891</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;步骤2:&quot;</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 892</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;如图&quot;</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 893</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;转几周&quot;</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 894</span>        <span class="n">oled</span><span class="o">.</span><span class="n">bitmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">calibrate_img</span><span class="o">.</span><span class="n">rotate1</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 895</span>        <span class="n">oled</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos"> 896</span>        <span class="n">ticks_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ticks_ms</span><span class="p">()</span>
<span class="linenos"> 897</span>        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ticks_diff</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ticks_ms</span><span class="p">(),</span> <span class="n">ticks_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">)</span> <span class="p">:</span>
<span class="linenos"> 898</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 899</span>            <span class="n">min_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span><span class="p">,</span> <span class="n">min_z</span><span class="p">)</span>
<span class="linenos"> 900</span>            <span class="n">max_z</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_z</span><span class="p">,</span> <span class="n">max_z</span><span class="p">)</span>
<span class="linenos"> 901</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 902</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_z</span> <span class="o">+</span> <span class="n">min_z</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos"> 903</span>  
<span class="linenos"> 904</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cali_offset_z: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_z</span><span class="p">))</span>
<span class="linenos"> 905</span>
<span class="linenos"> 906</span>        <span class="n">oled</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 907</span>        <span class="n">oled</span><span class="o">.</span><span class="n">DispChar</span><span class="p">(</span><span class="s2">&quot;校准完成&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 908</span>        <span class="n">oled</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos"> 909</span>        <span class="n">oled</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 910</span>
<span class="linenos"> 911</span>    <span class="k">def</span> <span class="nf">get_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 912</span>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 913</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 914</span>            <span class="n">temp_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span>
<span class="linenos"> 915</span>            <span class="n">temp_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span>
<span class="linenos"> 916</span>            <span class="c1"># temp_z = self.raw_z - self.cali_offset_z</span>
<span class="linenos"> 917</span>            <span class="n">heading</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">temp_y</span><span class="p">,</span> <span class="o">-</span><span class="n">temp_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="mf">3.14159265</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">+</span> <span class="mi">3</span>
<span class="linenos"> 918</span>            <span class="k">return</span> <span class="n">heading</span>
<span class="linenos"> 919</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 920</span>            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span><span class="p">):</span>
<span class="linenos"> 921</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw</span><span class="p">()</span>
<span class="linenos"> 922</span>                <span class="n">temp_x</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_x</span><span class="p">)</span>
<span class="linenos"> 923</span>                <span class="n">temp_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cali_offset_y</span><span class="p">)</span>
<span class="linenos"> 924</span>                <span class="n">heading</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">temp_y</span><span class="p">,</span> <span class="o">-</span><span class="n">temp_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="mf">3.14159265</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">+</span> <span class="mi">3</span>
<span class="linenos"> 925</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 926</span>                <span class="n">heading</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_y</span><span class="p">(),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="mf">3.14159265</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span> <span class="o">+</span> <span class="mi">3</span>
<span class="linenos"> 927</span>            <span class="k">return</span> <span class="n">heading</span>
<span class="linenos"> 928</span>        
<span class="linenos"> 929</span>    <span class="k">def</span> <span class="nf">_get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 930</span>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 931</span>            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 932</span>            <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 933</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 934</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x09\x02</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 935</span>                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 936</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 937</span>                        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 938</span>                        <span class="n">status</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 939</span>                        <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">):</span>
<span class="linenos"> 940</span>                            <span class="k">break</span>
<span class="linenos"> 941</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x07</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 942</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 943</span>                    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">0.8</span> <span class="o">-</span><span class="mi">75</span>
<span class="linenos"> 944</span>                    <span class="c1"># print(data)</span>
<span class="linenos"> 945</span>                    <span class="k">return</span> <span class="n">temp</span>
<span class="linenos"> 946</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 947</span>                    <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 948</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 949</span>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>   
<span class="linenos"> 950</span>        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 951</span>            <span class="k">pass</span>
<span class="linenos"> 952</span>
<span class="linenos"> 953</span>    <span class="k">def</span> <span class="nf">_get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 954</span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 955</span>            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 956</span>            <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 957</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 958</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x2f</span><span class="p">]),</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 959</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 960</span>                    <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="linenos"> 961</span>                    <span class="nb">id</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 962</span>                    <span class="k">return</span> <span class="nb">id</span>
<span class="linenos"> 963</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 964</span>                    <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 965</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 966</span>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 967</span>        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 968</span>            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 969</span>            <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 970</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 971</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x39</span><span class="p">]),</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 972</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 973</span>                    <span class="nb">id</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 974</span>                    <span class="k">return</span> <span class="nb">id</span>
<span class="linenos"> 975</span>                <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 976</span>                    <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 977</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 978</span>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos"> 979</span>
<span class="linenos"> 980</span>    <span class="k">def</span> <span class="nf">_judge_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 981</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 982</span><span class="sd">        判断product_ID</span>
<span class="linenos"> 983</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 984</span>        <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 985</span>        <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos"> 986</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 987</span>                <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x39</span><span class="p">]),</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 988</span>                <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 989</span>                <span class="nb">id</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 990</span>                <span class="k">if</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="mi">16</span><span class="p">):</span>
<span class="linenos"> 991</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos"> 992</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">product_ID</span> <span class="o">=</span> <span class="mi">16</span>
<span class="linenos"> 993</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 994</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 995</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">product_ID</span> <span class="o">=</span> <span class="mi">48</span>
<span class="linenos"> 996</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 997</span>                <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 998</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 999</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span> 
<span class="linenos">1000</span>
<span class="linenos">1001</span><span class="c1"># Magnetic</span>
<span class="linenos">1002</span><span class="k">if</span> <span class="mi">48</span> <span class="ow">in</span> <span class="n">i2c</span><span class="o">.</span><span class="n">scan</span><span class="p">():</span>
<span class="linenos">1003</span>    <span class="n">magnetic</span> <span class="o">=</span> <span class="n">Magnetic</span><span class="p">()</span>
<span class="linenos">1004</span>
<span class="linenos">1005</span><span class="k">class</span> <span class="nc">BME280</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">1006</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1007</span>        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">119</span>
<span class="linenos">1008</span>        <span class="c1"># The “ctrl_hum” register sets the humidity data acquisition options of the device</span>
<span class="linenos">1009</span>        <span class="c1"># 0x01 = [2:0]oversampling ×1</span>
<span class="linenos">1010</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF2\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1011</span>        <span class="c1"># The “ctrl_meas” register sets the pressure and temperature data acquisition options of the device.</span>
<span class="linenos">1012</span>        <span class="c1"># The register needs to be written after changing “ctrl_hum” for the changes to become effective.</span>
<span class="linenos">1013</span>        <span class="c1"># 0x27 = [7:5]Pressure oversampling ×1 | [4:2]Temperature oversampling ×4 | [1:0]Normal mode</span>
<span class="linenos">1014</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF4\x27</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1015</span>        <span class="c1"># The “config” register sets the rate, filter and interface options of the device. Writes to the “config”</span>
<span class="linenos">1016</span>        <span class="c1"># register in normal mode may be ignored. In sleep mode writes are not ignored.</span>
<span class="linenos">1017</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF5\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1018</span>
<span class="linenos">1019</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x88</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1020</span>        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="linenos">1021</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;Hhh&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x8E</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1024</span>        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="linenos">1025</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;Hhhhhhhhh&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="linenos">1026</span>
<span class="linenos">1027</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xA1</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1028</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="linenos">1029</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1030</span>        <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xE1</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1031</span>        <span class="n">buff</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="linenos">1032</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ustruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1033</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">1034</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
<span class="linenos">1035</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
<span class="linenos">1036</span>        <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">1037</span>
<span class="linenos">1038</span>    <span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1039</span>        <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1040</span>        <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos">1041</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1042</span>                <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1043</span>                <span class="n">buff</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos">1044</span>                <span class="n">T</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
<span class="linenos">1045</span>                <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">/</span> <span class="mf">16384.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">1046</span>                <span class="n">c2</span> <span class="o">=</span> <span class="p">((</span><span class="n">T</span> <span class="o">/</span> <span class="mf">131072.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">8192.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">/</span> <span class="mf">131072.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">8192.0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">1047</span>                <span class="bp">self</span><span class="o">.</span><span class="n">tFine</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span>
<span class="linenos">1048</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFine</span> <span class="o">/</span> <span class="mf">5120.0</span>
<span class="linenos">1049</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos">1050</span>                <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1051</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1052</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos">1053</span>
<span class="linenos">1054</span>    <span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1055</span>        <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1056</span>        <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos">1057</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1058</span>                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
<span class="linenos">1059</span>                <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF7</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1060</span>                <span class="n">buff</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="linenos">1061</span>                <span class="n">P</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
<span class="linenos">1062</span>                <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFine</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">64000.0</span>
<span class="linenos">1063</span>                <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">c1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mf">32768.0</span>
<span class="linenos">1064</span>                <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>
<span class="linenos">1065</span>                <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">65536.0</span>
<span class="linenos">1066</span>                <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">c1</span> <span class="o">/</span> <span class="mf">524288.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">524288.0</span>
<span class="linenos">1067</span>                <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="mf">32768.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1068</span>                <span class="k">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">1069</span>                    <span class="k">return</span> <span class="mi">0</span>
<span class="linenos">1070</span>                <span class="n">p</span> <span class="o">=</span> <span class="mf">1048576.0</span> <span class="o">-</span> <span class="n">P</span>
<span class="linenos">1071</span>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">/</span> <span class="mf">4096.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">6250.0</span> <span class="o">/</span> <span class="n">c1</span>
<span class="linenos">1072</span>                <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="mf">2147483648.0</span>
<span class="linenos">1073</span>                <span class="n">c2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">/</span> <span class="mf">32768.0</span>
<span class="linenos">1074</span>                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_P</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">/</span> <span class="mf">16.0</span>
<span class="linenos">1075</span>                <span class="k">return</span> <span class="n">p</span>
<span class="linenos">1076</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos">1077</span>                <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1078</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1079</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos">1080</span>
<span class="linenos">1081</span>    <span class="k">def</span> <span class="nf">humidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1082</span>        <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1083</span>        <span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos">1084</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1085</span>                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">()</span>
<span class="linenos">1086</span>                <span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFD</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1087</span>                <span class="n">buff</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">1088</span>                <span class="n">H</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">1089</span>                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFine</span> <span class="o">-</span> <span class="mf">76800.0</span>
<span class="linenos">1090</span>                <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">16384.0</span> <span class="o">*</span> <span class="n">h</span><span class="p">))</span> <span class="o">*</span> \
<span class="linenos">1091</span>                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">65536.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mf">67108864.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> \
<span class="linenos">1092</span>                    <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">67108864.0</span> <span class="o">*</span> <span class="n">h</span><span class="p">)))</span>
<span class="linenos">1093</span>                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dig_H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">524288.0</span><span class="p">)</span>
<span class="linenos">1094</span>                <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
<span class="linenos">1095</span>                    <span class="k">return</span> <span class="mf">100.0</span>
<span class="linenos">1096</span>                <span class="k">elif</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="linenos">1097</span>                    <span class="k">return</span> <span class="mf">0.0</span>
<span class="linenos">1098</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1099</span>                    <span class="k">return</span> <span class="n">h</span>
<span class="linenos">1100</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos">1101</span>                <span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1102</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1103</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;i2c read/write error!&quot;</span><span class="p">)</span>
<span class="linenos">1104</span>
<span class="linenos">1105</span><span class="c1"># bm280</span>
<span class="linenos">1106</span><span class="c1"># if 119 in i2c.scan():</span>
<span class="linenos">1107</span><span class="c1">#     bme280 = BME280()</span>
<span class="linenos">1108</span>
<span class="linenos">1109</span><span class="k">class</span> <span class="nc">PinMode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">1110</span>    <span class="n">IN</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">1111</span>    <span class="n">OUT</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">1112</span>    <span class="n">PWM</span> <span class="o">=</span> <span class="mi">3</span>
<span class="linenos">1113</span>    <span class="n">ANALOG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="linenos">1114</span>    <span class="n">OUT_DRAIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="linenos">1115</span>
<span class="linenos">1116</span>
<span class="linenos">1117</span><span class="n">pins_remap_esp32</span> <span class="o">=</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
<span class="linenos">1118</span>                    <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos">1119</span>
<span class="linenos">1120</span>
<span class="linenos">1121</span><span class="k">class</span> <span class="nc">MPythonPin</span><span class="p">():</span>
<span class="linenos">1122</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">PinMode</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1123</span>        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PinMode</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">PWM</span><span class="p">,</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">,</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">OUT_DRAIN</span><span class="p">]:</span>
<span class="linenos">1124</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;IN, OUT, PWM, ANALOG,OUT_DRAIN&#39;&quot;</span><span class="p">)</span>
<span class="linenos">1125</span>        <span class="k">if</span> <span class="n">pin</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
<span class="linenos">1126</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;P4 is used for light sensor&quot;</span><span class="p">)</span>
<span class="linenos">1127</span>        <span class="k">if</span> <span class="n">pin</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
<span class="linenos">1128</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;P10 is used for sound sensor&quot;</span><span class="p">)</span>
<span class="linenos">1129</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1130</span>            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pins_remap_esp32</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span>
<span class="linenos">1131</span>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
<span class="linenos">1132</span>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Out of Pin range&quot;</span><span class="p">)</span>
<span class="linenos">1133</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
<span class="linenos">1134</span>            <span class="c1"># if pin in [3]:</span>
<span class="linenos">1135</span>            <span class="c1">#     raise TypeError(&#39;IN not supported on P%d&#39; % pin)</span>
<span class="linenos">1136</span>            <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull</span><span class="p">)</span>
<span class="linenos">1137</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
<span class="linenos">1138</span>            <span class="k">if</span> <span class="n">pin</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
<span class="linenos">1139</span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;OUT not supported on P</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pin</span><span class="p">)</span>
<span class="linenos">1140</span>            <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">pull</span><span class="p">)</span>
<span class="linenos">1141</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">OUT_DRAIN</span><span class="p">:</span>
<span class="linenos">1142</span>            <span class="k">if</span> <span class="n">pin</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
<span class="linenos">1143</span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;OUT_DRAIN not supported on P</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pin</span><span class="p">)</span>
<span class="linenos">1144</span>            <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OPEN_DRAIN</span><span class="p">,</span> <span class="n">pull</span><span class="p">)</span>
<span class="linenos">1145</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">PWM</span><span class="p">:</span>
<span class="linenos">1146</span>            <span class="k">if</span> <span class="n">pin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">]:</span>
<span class="linenos">1147</span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;PWM not supported on P</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pin</span><span class="p">)</span>
<span class="linenos">1148</span>            <span class="bp">self</span><span class="o">.</span><span class="n">pwm</span> <span class="o">=</span> <span class="n">PWM</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">duty</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1149</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
<span class="linenos">1150</span>            <span class="k">if</span> <span class="n">pin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
<span class="linenos">1151</span>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;ANALOG not supported on P</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pin</span><span class="p">)</span>
<span class="linenos">1152</span>            <span class="bp">self</span><span class="o">.</span><span class="n">adc</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
<span class="linenos">1153</span>            <span class="bp">self</span><span class="o">.</span><span class="n">adc</span><span class="o">.</span><span class="n">atten</span><span class="p">(</span><span class="n">ADC</span><span class="o">.</span><span class="n">ATTN_11DB</span><span class="p">)</span>
<span class="linenos">1154</span>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
<span class="linenos">1155</span>
<span class="linenos">1156</span>    <span class="k">def</span> <span class="nf">irq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">):</span>
<span class="linenos">1157</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
<span class="linenos">1158</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the pin is not in IN mode&#39;</span><span class="p">)</span>
<span class="linenos">1159</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
<span class="linenos">1160</span>
<span class="linenos">1161</span>    <span class="k">def</span> <span class="nf">read_digital</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1162</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">IN</span><span class="p">:</span>
<span class="linenos">1163</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the pin is not in IN mode&#39;</span><span class="p">)</span>
<span class="linenos">1164</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
<span class="linenos">1165</span>
<span class="linenos">1166</span>    <span class="k">def</span> <span class="nf">write_digital</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">1167</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PinMode</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">OUT_DRAIN</span><span class="p">]:</span>
<span class="linenos">1168</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the pin is not in OUT or OUT_DRAIN mode&#39;</span><span class="p">)</span>
<span class="linenos">1169</span>        <span class="bp">self</span><span class="o">.</span><span class="n">Pin</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1170</span>
<span class="linenos">1171</span>    <span class="k">def</span> <span class="nf">read_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1172</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
<span class="linenos">1173</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the pin is not in ANALOG mode&#39;</span><span class="p">)</span>
<span class="linenos">1174</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos">1175</span>        
<span class="linenos">1176</span>
<span class="linenos">1177</span>    <span class="k">def</span> <span class="nf">write_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="linenos">1178</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PinMode</span><span class="o">.</span><span class="n">PWM</span><span class="p">:</span>
<span class="linenos">1179</span>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the pin is not in PWM mode&#39;</span><span class="p">)</span>
<span class="linenos">1180</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pwm</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
<span class="linenos">1181</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pwm</span><span class="o">.</span><span class="n">duty</span><span class="p">(</span><span class="n">duty</span><span class="p">)</span>
<span class="linenos">1182</span>
<span class="linenos">1183</span>
<span class="linenos">1184</span><span class="sd">&#39;&#39;&#39;</span>
<span class="linenos">1185</span><span class="sd"># to be test</span>
<span class="linenos">1186</span><span class="sd">class LightSensor(ADC):</span>
<span class="linenos">1187</span><span class="sd">    </span>
<span class="linenos">1188</span><span class="sd">    def __init__(self):</span>
<span class="linenos">1189</span><span class="sd">        super().__init__(Pin(pins_remap_esp32[4]))</span>
<span class="linenos">1190</span><span class="sd">        # super().atten(ADC.ATTN_11DB)</span>
<span class="linenos">1191</span><span class="sd">    </span>
<span class="linenos">1192</span><span class="sd">    def value(self):</span>
<span class="linenos">1193</span><span class="sd">        # lux * k * Rc = N * 3.9/ 4096</span>
<span class="linenos">1194</span><span class="sd">        # k = 0.0011mA/Lux</span>
<span class="linenos">1195</span><span class="sd">        # lux = N * 3.9/ 4096 / Rc / k</span>
<span class="linenos">1196</span><span class="sd">        return super().read() * 1.1 / 4095 / 6.81 / 0.011</span>
<span class="linenos">1197</span><span class="sd">    </span>
<span class="linenos">1198</span><span class="sd">&#39;&#39;&#39;</span>
<span class="linenos">1199</span>
<span class="linenos">1200</span>
<span class="linenos">1201</span><span class="k">class</span> <span class="nc">wifi</span><span class="p">:</span>
<span class="linenos">1202</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1203</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sta</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>
<span class="linenos">1204</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ap</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">AP_IF</span><span class="p">)</span>
<span class="linenos">1205</span>
<span class="linenos">1206</span>    <span class="k">def</span> <span class="nf">connectWiFi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos">1207</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
<span class="linenos">1208</span>            <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
<span class="linenos">1209</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1210</span>        <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
<span class="linenos">1211</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wifi_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="linenos">1212</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1213</span>                <span class="k">if</span> <span class="n">wifi_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="n">ssid</span><span class="p">:</span>
<span class="linenos">1214</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>
<span class="linenos">1215</span>                    <span class="n">wifi_dbm</span> <span class="o">=</span> <span class="n">wifi_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">1216</span>                    <span class="k">break</span>
<span class="linenos">1217</span>            <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
<span class="linenos">1218</span>                <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>
<span class="linenos">1219</span>                <span class="n">wifi_dbm</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
<span class="linenos">1220</span>                <span class="k">break</span>
<span class="linenos">1221</span>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1222</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;SSID invalid / failed to scan this wifi&quot;</span><span class="p">)</span>
<span class="linenos">1223</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos">1224</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection WiFi&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">1225</span>        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">):</span>
<span class="linenos">1226</span>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">ticks_diff</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
<span class="linenos">1227</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">1228</span>                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Timeout!,check your wifi password and keep your network unblocked&quot;</span><span class="p">)</span>
<span class="linenos">1229</span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">1230</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="linenos">1231</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">1232</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WiFi(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">dBm) Connection Successful, Config:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wifi_dbm</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">())))</span>
<span class="linenos">1233</span>
<span class="linenos">1234</span>    <span class="k">def</span> <span class="nf">disconnectWiFi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1235</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
<span class="linenos">1236</span>            <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
<span class="linenos">1237</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">1238</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnect WiFi...&#39;</span><span class="p">)</span>
<span class="linenos">1239</span>
<span class="linenos">1240</span>    <span class="k">def</span> <span class="nf">enable_APWiFi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos">1241</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ap</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1242</span>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
<span class="linenos">1243</span>            <span class="n">authmode</span><span class="o">=</span><span class="mi">4</span>
<span class="linenos">1244</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1245</span>            <span class="n">authmode</span><span class="o">=</span><span class="mi">0</span>
<span class="linenos">1246</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ap</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">essid</span><span class="o">=</span><span class="n">essid</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span><span class="n">authmode</span><span class="o">=</span><span class="n">authmode</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
<span class="linenos">1247</span>
<span class="linenos">1248</span>    <span class="k">def</span> <span class="nf">disable_APWiFi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1249</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ap</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">1250</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disable AP WiFi...&#39;</span><span class="p">)</span>
<span class="linenos">1251</span>
<span class="linenos">1252</span>
<span class="linenos">1253</span><span class="c1"># 3 rgb leds</span>
<span class="linenos">1254</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">NeoPixel</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="linenos">1255</span><span class="n">rgb</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="linenos">1256</span>
<span class="linenos">1257</span><span class="c1"># light sensor</span>
<span class="linenos">1258</span><span class="n">light</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">39</span><span class="p">))</span>
<span class="linenos">1259</span><span class="n">light</span><span class="o">.</span><span class="n">atten</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">ATTN_11DB</span><span class="p">)</span>
<span class="linenos">1260</span>
<span class="linenos">1261</span><span class="c1"># sound sensor</span>
<span class="linenos">1262</span><span class="n">sound</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">36</span><span class="p">))</span>
<span class="linenos">1263</span><span class="n">sound</span><span class="o">.</span><span class="n">atten</span><span class="p">(</span><span class="n">sound</span><span class="o">.</span><span class="n">ATTN_11DB</span><span class="p">)</span>
<span class="linenos">1264</span>
<span class="linenos">1265</span><span class="c1"># buttons</span>
<span class="linenos">1266</span><span class="k">class</span> <span class="nc">Button</span><span class="p">:</span>
<span class="linenos">1267</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_num</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1268</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__reverse</span> <span class="o">=</span> <span class="n">reverse</span>
<span class="linenos">1269</span>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__press_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__release_level</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reverse</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">1270</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="n">pin_num</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">pull</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">PULL_UP</span><span class="p">)</span>
<span class="linenos">1271</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_FALLING</span> <span class="o">|</span> <span class="n">Pin</span><span class="o">.</span><span class="n">IRQ_RISING</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__irq_handler</span><span class="p">)</span>
<span class="linenos">1272</span>        <span class="c1"># self.__user_irq = None</span>
<span class="linenos">1273</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1274</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event_released</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1275</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1276</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1277</span>        <span class="c1"># print(&quot;level: pressed is {}, released is {}.&quot; .format(self.__press_level, self.__release_level))</span>
<span class="linenos">1278</span>    
<span class="linenos">1279</span>
<span class="linenos">1280</span>    <span class="k">def</span> <span class="nf">__irq_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
<span class="linenos">1281</span>        <span class="n">irq_falling</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">pin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__press_level</span> <span class="k">else</span> <span class="kc">False</span>
<span class="linenos">1282</span>        <span class="c1"># debounce</span>
<span class="linenos">1283</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">1284</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__press_level</span> <span class="k">if</span> <span class="n">irq_falling</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__release_level</span><span class="p">):</span>
<span class="linenos">1285</span>            <span class="c1"># new event handler</span>
<span class="linenos">1286</span>            <span class="c1"># pressed event</span>
<span class="linenos">1287</span>            <span class="k">if</span> <span class="n">irq_falling</span><span class="p">:</span>
<span class="linenos">1288</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1289</span>                    <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="p">)</span>
<span class="linenos">1290</span>                <span class="c1"># key status</span>
<span class="linenos">1291</span>                <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1292</span>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
<span class="linenos">1293</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1294</span>            <span class="c1"># release event</span>
<span class="linenos">1295</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1296</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_released</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1297</span>                    <span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_released</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="p">)</span>
<span class="linenos">1298</span>
<span class="linenos">1299</span>                
<span class="linenos">1300</span>    <span class="k">def</span> <span class="nf">is_pressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1301</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__press_level</span><span class="p">:</span>
<span class="linenos">1302</span>            <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">1303</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1304</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">1305</span>
<span class="linenos">1306</span>    <span class="k">def</span> <span class="nf">was_pressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1307</span>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span>
<span class="linenos">1308</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1309</span>        <span class="k">return</span> <span class="n">r</span>
<span class="linenos">1310</span>
<span class="linenos">1311</span>    <span class="k">def</span> <span class="nf">get_presses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1312</span>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span>
<span class="linenos">1313</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1314</span>        <span class="k">return</span> <span class="n">r</span>
<span class="linenos">1315</span>
<span class="linenos">1316</span>    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1317</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
<span class="linenos">1318</span>
<span class="linenos">1319</span>    <span class="k">def</span> <span class="nf">irq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="linenos">1320</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pin</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="linenos">1321</span>
<span class="linenos">1322</span>
<span class="linenos">1323</span>
<span class="linenos">1324</span><span class="k">class</span> <span class="nc">Touch</span><span class="p">:</span>
<span class="linenos">1325</span>
<span class="linenos">1326</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
<span class="linenos">1327</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__touch_pad</span> <span class="o">=</span> <span class="n">TouchPad</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
<span class="linenos">1328</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__touch_pad</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__irq_handler</span><span class="p">)</span>
<span class="linenos">1329</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1330</span>        <span class="bp">self</span><span class="o">.</span><span class="n">event_released</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1331</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1332</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1333</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1334</span>
<span class="linenos">1335</span>    <span class="k">def</span> <span class="nf">__irq_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">1336</span>        <span class="c1"># when pressed</span>
<span class="linenos">1337</span>        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1338</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1339</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_pressed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1340</span>            <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1341</span>            <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">1342</span>            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
<span class="linenos">1343</span>                <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">1344</span>        <span class="c1"># when released</span>
<span class="linenos">1345</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1346</span>            <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1347</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_released</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1348</span>                <span class="bp">self</span><span class="o">.</span><span class="n">event_released</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1349</span>            
<span class="linenos">1350</span>    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="linenos">1351</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__touch_pad</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
<span class="linenos">1352</span>
<span class="linenos">1353</span>    <span class="k">def</span> <span class="nf">is_pressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1354</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value</span><span class="p">:</span>
<span class="linenos">1355</span>            <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">1356</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1357</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">1358</span>
<span class="linenos">1359</span>    <span class="k">def</span> <span class="nf">was_pressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1360</span>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span>
<span class="linenos">1361</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__was_pressed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1362</span>        <span class="k">return</span> <span class="n">r</span>
<span class="linenos">1363</span>
<span class="linenos">1364</span>    <span class="k">def</span> <span class="nf">get_presses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1365</span>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span>
<span class="linenos">1366</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__pressed_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1367</span>        <span class="k">return</span> <span class="n">r</span>
<span class="linenos">1368</span>
<span class="linenos">1369</span>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1370</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__touch_pad</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos">1371</span>
<span class="linenos">1372</span>
<span class="linenos">1373</span><span class="c1"># button_a = Pin(0, Pin.IN, Pin.PULL_UP)</span>
<span class="linenos">1374</span><span class="c1"># button_b = Pin(2, Pin.IN, Pin.PULL_UP)</span>
<span class="linenos">1375</span><span class="n">button_a</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1376</span><span class="n">button_b</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">1377</span>
<span class="linenos">1378</span>
<span class="linenos">1379</span><span class="c1"># touchpad</span>
<span class="linenos">1380</span><span class="n">touchpad_p</span> <span class="o">=</span> <span class="n">touchPad_P</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">27</span><span class="p">))</span>
<span class="linenos">1381</span><span class="n">touchpad_y</span> <span class="o">=</span> <span class="n">touchPad_Y</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
<span class="linenos">1382</span><span class="n">touchpad_t</span> <span class="o">=</span> <span class="n">touchPad_T</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<span class="linenos">1383</span><span class="n">touchpad_h</span> <span class="o">=</span> <span class="n">touchPad_H</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
<span class="linenos">1384</span><span class="n">touchpad_o</span> <span class="o">=</span> <span class="n">touchPad_O</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<span class="linenos">1385</span><span class="n">touchpad_n</span> <span class="o">=</span> <span class="n">touchPad_N</span> <span class="o">=</span> <span class="n">Touch</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="linenos">1386</span>
<span class="linenos">1387</span><span class="kn">from</span> <span class="nn">gui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos">1388</span>
<span class="linenos">1389</span>
<span class="linenos">1390</span><span class="k">def</span> <span class="nf">numberMap</span><span class="p">(</span><span class="n">inputNum</span><span class="p">,</span> <span class="n">bMin</span><span class="p">,</span> <span class="n">bMax</span><span class="p">,</span> <span class="n">cMin</span><span class="p">,</span> <span class="n">cMax</span><span class="p">):</span>
<span class="linenos">1391</span>    <span class="n">outputNum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1392</span>    <span class="n">outputNum</span> <span class="o">=</span> <span class="p">((</span><span class="n">cMax</span> <span class="o">-</span> <span class="n">cMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bMax</span> <span class="o">-</span> <span class="n">bMin</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">inputNum</span> <span class="o">-</span> <span class="n">bMin</span><span class="p">)</span> <span class="o">+</span> <span class="n">cMin</span>
<span class="linenos">1393</span>    <span class="k">return</span> <span class="n">outputNum</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright ACEBOTT All Rights Reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-XXXXXXX-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>